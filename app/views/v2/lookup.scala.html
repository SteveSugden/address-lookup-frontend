@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import model._
@import model.MessageConstants.{EnglishMessageConstants, WelshMessageConstants, MessageConstants}
@import config.FrontendAppConfig
@import views.html.helpers.head
@import config.FooterLinks

@this(govukLayout: GovukLayout, head: head, footer: GovukFooter, banner: HmrcBanner, help: HmrcReportTechnicalIssue,
form: FormWithCSRF, textarea: govukTextarea, button: govukButton, govukBackLink: GovukBackLink,
        errorSummary: GovukErrorSummary, textInput: GovukInput, languageSwitch: HmrcLanguageSelect)
@(id: String,
journeyData: JourneyDataV2,
lookupForm: Form[Lookup],
isWelsh: Boolean,
isUKMode: Boolean = true,
message: Option[String] = None
)(implicit request: Request[_], messages: Messages, appConfig: FrontendAppConfig)

@messageConstants = @{if(isWelsh) WelshMessageConstants(isUKMode) else EnglishMessageConstants(isUKMode)}

@errorPrefix = @{if(isWelsh) "Gwall: " else "Error: "}

@titleWithError = @{
  if(lookupForm.errors) {
    errorPrefix + journeyData.resolveConfigV2(isWelsh, appConfig).labels.lookupPageLabels.title
  } else {
    journeyData.resolveConfigV2(isWelsh, appConfig).labels.lookupPageLabels.title
  }
}
@scriptElem = {
  <script type="text/javascript">
    window.onpageshow = function(event) {
      $('button[disabled]').prop('disabled', false);
    };
  </script>
}

@beforeContent = {
    @banner(Banner())

    @if(journeyData.resolveConfigV2(isWelsh, appConfig).options.showBackButtons) {
        @govukBackLink(BackLink(href="javascript:history.back()", content = HtmlContent(messageConstants.back)))
    }

    @languageSwitch(LanguageSelect(messages.lang.code match {
        case "en" ⇒ En
        case "cy" ⇒ Cy
    }, En -> s"${controllers.routes.LanguageController.switchToLanguage("english")}",
        Cy -> s"${controllers.routes.LanguageController.switchToLanguage("cymraeg")}"
    )
    )
}

@govukLayout(
    pageTitle = Some(titleWithError),
    headBlock = Some(head()),
    beforeContentBlock = Some(beforeContent),
    scriptsBlock = Some(scriptElem),
    footerBlock = Some(footer(Footer(
        meta = Some(Meta(
            visuallyHiddenTitle = Some("Support links"),
            items = Some(FooterLinks())
        ))
    )))
    ) {

    @if(lookupForm.hasErrors) {
        @errorSummary(ErrorSummary(title = HtmlContent(messageConstants.errorText),
            errorList = lookupForm.errors.map{error ⇒ ErrorLink(href=Some(s"#${error.key}"), content = HtmlContent(messages(error.message)))}))
    }

  @form(routes.AddressLookupController.select(id)) {
      <header class="page-header">
        <h1 class="govuk-heading-l" id="pageHeading">@{journeyData.resolveConfigV2(isWelsh, appConfig).labels.lookupPageLabels.heading}</h1>
      </header>

      @if(message.isDefined) {
      <div class="highlight-message highlight-message--full-width">
        <p>@{message.get}</p>
      </div>
      }

      @textInput(Input(
          label = Label(content = HtmlContent(journeyData.resolveConfigV2(isWelsh, appConfig).labels.lookupPageLabels.postcodeLabel)),
          name = lookupForm("postcode").name,
          value = lookupForm("postcode").value,
          classes = "govuk-input--width-10",
          id = lookupForm("postcode").id, errorMessage = lookupForm("postcode").error.map(fe ⇒ ErrorMessage(content = HtmlContent(fe.message)))))

        <p class="govuk-!-margin-bottom-6 govuk-body">
            <a href="@{routes.AddressLookupController.edit(id)}" id="manualAddress" class="govuk-link">@{journeyData.resolveConfigV2(isWelsh, appConfig).labels.lookupPageLabels.manualAddressLinkText}</a>
        </p>

      @textInput(Input(
          label = Label(content = HtmlContent(journeyData.resolveConfigV2(isWelsh, appConfig).labels.lookupPageLabels.filterLabel)),
          name = lookupForm("filter").name,
          value = lookupForm("filter").value,
          classes = "govuk-input--width-20",
          id = lookupForm("filter").id,
          errorMessage = lookupForm("filter").error.map(fe ⇒ ErrorMessage(content = HtmlContent(fe.message))),
          hint = Some(Hint(content = HtmlContent(messageConstants.lookupFilterHint)))))


      @button(Button(content = HtmlContent(journeyData.resolveConfigV2(isWelsh, appConfig).labels.lookupPageLabels.submitLabel),
          name=Some("continue"),
          inputType=Some("submit")))
  }
}
